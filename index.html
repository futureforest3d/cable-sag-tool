<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Cable Sag Tool</title>
    <style>
        body { font-family: Arial; background: #f5f5f5; padding: 10px; }
        h1 { text-align: center; background: #2c3e50; color: white; padding: 15px; }
        .main { display: flex; gap: 10px; max-width: 1600px; margin: 0 auto; }
        #canvas { border: 2px solid #333; background: white; }
        .controls { background: white; padding: 15px; border-radius: 5px; margin-top: 10px; }
        .row { display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap; }
        .group { flex: 1; min-width: 140px; }
        .group label { display: block; font-weight: bold; font-size: 12px; margin-bottom: 3px; }
        .group input[type="range"] { width: 100%; }
        .group input[type="number"] { width: 80px; margin-top: 3px; }
        .bulb-panel { background: #e8e8e8; padding: 15px; min-width: 350px; max-width: 350px; }
        .bulb-part { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .bulb-part input { width: 80px; text-align: right; }
        .btn { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; margin: 5px; }
        .btn-save { background: #4CAF50; color: white; }
        .btn-load { background: #2196F3; color: white; }
        .btn-export { background: #FF9800; color: white; }
        .mode-controls { background: #f0f8ff; padding: 10px; border-radius: 5px; margin-top: 10px; border: 1px solid #ccc; }
        .canvas-container { position: relative; display: inline-block; }
        .pan-x-container { 
            display: flex; 
            align-items: center; 
            gap: 5px; 
            margin-top: 5px;
            padding: 5px;
            background: #eee;
            border-radius: 3px;
        }
        .pan-x-container input[type="range"] { flex: 1; }
        .pan-x-container input[type="number"] { width: 60px; }
        .zoom-container { 
            display: flex; 
            align-items: center; 
            gap: 5px; 
            margin-top: 5px;
            padding: 5px;
            background: #ddd;
            border-radius: 3px;
        }
        .zoom-container input[type="range"] { flex: 1; }
        .zoom-container input[type="number"] { width: 60px; }
        .pan-y-container {
            position: absolute;
            right: -45px;
            top: 0;
            height: 460px;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 5px;
            background: #eee;
            border-radius: 3px;
            width: 40px;
        }
        .pan-y-container input[type="range"] {
            writing-mode: vertical-lr;
            direction: rtl;
            height: 380px;
            width: 20px;
        }
        .pan-y-container input[type="number"] { 
            width: 40px; 
            font-size: 10px;
            margin-top: 5px;
        }
        .pan-y-container label {
            font-size: 10px;
            font-weight: bold;
        }
        .id-input-container { display: flex; align-items: center; justify-content: center; gap: 5px; }
        .id-input-container input[type="number"] { width: 50px; text-align: center; }
    </style>
</head>
<body>
    <h1>Cable Sag Analysis Tool</h1>
    <div class="main">
        <div style="flex:1">
            <div class="canvas-container">
                <canvas id="canvas" width="920" height="460"></canvas>
                <div class="pan-y-container">
                    <label>Pan Y</label>
                    <input type="range" id="pan-y" min="-1" max="1" step="0.01" value="0">
                    <input type="number" id="pan-y-num" min="-1" max="1" step="0.01" value="0">
                </div>
            </div>
            
            <!-- Pan X below canvas -->
            <div class="pan-x-container" style="width: 920px;">
                <label style="font-weight: bold; font-size: 12px; white-space: nowrap;">Pan X:</label>
                <input type="range" id="pan-x" min="-1" max="1" step="0.01" value="0">
                <input type="number" id="pan-x-num" min="-1" max="1" step="0.01" value="0">
            </div>
            
            <!-- Zoom below Pan X -->
            <div class="zoom-container" style="width: 920px;">
                <label style="font-weight: bold; font-size: 12px; white-space: nowrap;">Zoom:</label>
                <input type="range" id="zoom" min="0.5" max="1.5" step="0.01" value="1">
                <input type="number" id="zoom-num" min="0.5" max="1.5" step="0.01" value="1">
            </div>
            
            <div class="controls">
                <div class="row">
                    <div class="group">
                        <label>Span (m):</label>
                        <input type="range" id="span" min="1" max="60" step="0.1" value="50">
                        <input type="number" id="span-num" min="1" max="60" step="0.1" value="50">
                    </div>
                    <div class="group">
                        <label>Height (m):</label>
                        <input type="range" id="height" min="1" max="20" step="0.1" value="16">
                        <input type="number" id="height-num" min="1" max="20" step="0.1" value="16">
                    </div>
                    <div class="group">
                        <label>Cable Ø (mm):</label>
                        <input type="range" id="diam" min="2" max="20" step="0.1" value="10">
                        <input type="number" id="diam-num" min="2" max="20" step="0.1" value="10">
                    </div>
                    <div class="group">
                        <label>Tension (kN):</label>
                        <input type="range" id="tension" min="0" max="100" step="0.1" value="6.5">
                        <input type="number" id="tension-num" min="0" max="100" step="0.1" value="6.5">
                    </div>
                    <div class="group">
                        <label>Instances:</label>
                        <input type="range" id="instances" min="0" max="120" value="82">
                        <input type="number" id="instances-num" min="0" max="120" step="1" value="82">
                    </div>
                </div>
                
                <div class="mode-controls">
                    <div style="margin-bottom: 10px;">
                        <strong>Bulb Cable Mode:</strong>
                        <label style="margin-left: 15px;"><input type="radio" name="mode" value="flat" checked> Flat Height</label>
                        <label style="margin-left: 15px;"><input type="radio" name="mode" value="curve"> Sine Curve</label>
                    </div>
                    
                    <!-- Flat Height Controls -->
                    <div id="flat-ctrl">
                        <div class="row">
                            <div class="group">
                                <label>Bulb Height (m):</label>
                                <input type="range" id="bulb-h" min="0" max="20" step="0.01" value="2">
                                <input type="number" id="bulb-h-num" min="0" max="20" step="0.01" value="2">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Sine Curve Controls -->
                    <div id="curve-ctrl" style="display:none;">
                        <div class="row">
                            <div class="group">
                                <label>Curve Height (m):</label>
                                <input type="range" id="curve-amp" min="0" max="10" step="0.1" value="3">
                                <input type="number" id="curve-amp-num" min="0" max="10" step="0.1" value="3">
                            </div>
                            <div class="group">
                                <label>Offset X (m):</label>
                                <input type="range" id="curve-offset" min="-30" max="30" step="0.1" value="0">
                                <input type="number" id="curve-offset-num" min="-30" max="30" step="0.1" value="0">
                            </div>
                        </div>
                        <div class="row">
                            <div class="group">
                                <label>Curve Width:</label>
                                <input type="range" id="curve-freq" min="0.1" max="3" step="0.1" value="1">
                                <input type="number" id="curve-freq-num" min="0.1" max="3" step="0.1" value="1">
                            </div>
                            <div class="group">
                                <label>Base Height (m):</label>
                                <input type="range" id="curve-base" min="0" max="15" step="0.1" value="1">
                                <input type="number" id="curve-base-num" min="0" max="15" step="0.1" value="1">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="bulb-panel">
            <h3>Bulb Parts</h3>
            <div style="text-align:center; margin: 10px;">
                <div class="id-input-container">
                    <button onclick="prevId()">◀</button>
                    <label>ID:</label>
                    <input type="number" id="id-input" min="0" value="0">
                    <button onclick="nextId()">▶</button>
                </div>
            </div>
            
            <canvas id="bulb-diagram" width="320" height="280" style="background:white; display:block; margin:10px auto; border:1px solid #ccc;"></canvas>
            
            <div class="bulb-part"><label>PCB (kg)</label><input type="number" id="pcb" value="0.050" step="0.001"></div>
            <div class="bulb-part"><label>Housing (kg)</label><input type="number" id="housing" value="0.120" step="0.001"></div>
            <div class="bulb-part"><label>Connectors (kg)</label><input type="number" id="conn" value="0.035" step="0.001"></div>
            <div class="bulb-part"><label>Ethernet (kg)</label><input type="number" id="eth" value="0.025" step="0.001"></div>
            <div class="bulb-part"><label>Socket (kg)</label><input type="number" id="socket" value="0.045" step="0.001"></div>
            <div class="bulb-part"><label>Bulb (kg)</label><input type="number" id="bulb" value="0.065" step="0.001"></div>
            <div class="bulb-part"><label>Cable/M (kg)</label><input type="text" id="cable-w" readonly style="background:#f0f0f0"></div>
            <div style="text-align:center; margin:10px;"><label>g/m: <input type="number" id="gpm" value="50" style="width:60px"></label></div>
            <div style="text-align:center; margin:10px;"><strong>Cable Len: </strong><span id="cable-len">0</span> m</div>
            <div style="text-align:center; margin:10px; color:blue;"><strong>Total: </strong><span id="total">0</span> kg</div>
            <div style="background:white; padding:10px; margin:10px 0; border:2px solid #666;">
                <strong>Force Analysis</strong>
                <div>Load: <span id="f1">0</span> kg</div>
                <div>Force: <span id="f2">0</span> kN</div>
                <div>Cable: <span id="f3">0</span> kg</div>
                <div>Instances: <span id="f4">0</span> kg</div>
            </div>
            <div style="text-align:center;">
                <button class="btn btn-save" onclick="save()">Save</button>
                <button class="btn btn-load" onclick="load()">Load</button>
            </div>
            <div style="text-align:center; margin-top: 10px;">
                <button class="btn btn-export" onclick="exportCSV()">Export CSV</button>
            </div>
        </div>
    </div>
    <script>
        console.log('Script starting...');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const bulbCanvas = document.getElementById('bulb-diagram');
        const bulbCtx = bulbCanvas.getContext('2d');
        let cw = [], cl = [], cid = 0;
        // Store instance data for CSV export
        let instanceData = [];
        const STEEL = 7850, G = 9.81;
        
        function drawBulbDiagram() {
            bulbCtx.clearRect(0, 0, 320, 280);
            bulbCtx.strokeStyle = 'black';
            bulbCtx.fillStyle = 'black';
            
            // Cable line extending up
            bulbCtx.lineWidth = 2;
            bulbCtx.beginPath();
            bulbCtx.moveTo(250, 20);
            bulbCtx.lineTo(250, 60);
            bulbCtx.stroke();
            bulbCtx.beginPath();
            bulbCtx.moveTo(230, 60);
            bulbCtx.lineTo(270, 60);
            bulbCtx.stroke();
            
            // Socket (cylindrical top)
            bulbCtx.fillStyle = '#d0d0d0';
            bulbCtx.fillRect(235, 60, 30, 40);
            bulbCtx.strokeRect(235, 60, 30, 40);
            
            // Bulb (rounded bottom)
            bulbCtx.fillStyle = '#ffffcc';
            bulbCtx.beginPath();
            bulbCtx.ellipse(250, 120, 30, 30, 0, 0, 2 * Math.PI);
            bulbCtx.fill();
            bulbCtx.stroke();
            
            // Internal filament
            bulbCtx.strokeStyle = 'gray';
            bulbCtx.lineWidth = 1;
            bulbCtx.beginPath();
            bulbCtx.moveTo(240, 110);
            bulbCtx.lineTo(250, 125);
            bulbCtx.lineTo(260, 110);
            bulbCtx.stroke();
            
            // Housing/PCB area at top
            bulbCtx.fillStyle = '#666';
            bulbCtx.fillRect(240, 40, 20, 20);
            bulbCtx.strokeRect(240, 40, 20, 20);
            
            // Labels with arrows
            bulbCtx.fillStyle = 'black';
            bulbCtx.strokeStyle = 'black';
            bulbCtx.font = '9px Arial';
            bulbCtx.lineWidth = 1;
            
            const labels = [
                [150, 45, 240, 50, 'PCB'],
                [150, 75, 235, 70, 'Housing'],
                [140, 105, 220, 95, 'Connectors'],
                [130, 135, 220, 120, 'Ethernet'],
                [120, 165, 230, 60, 'Cable/M'],
                [130, 195, 235, 80, 'Socket'],
                [140, 225, 240, 130, 'Bulb']
            ];
            
            labels.forEach(([lx, ly, px, py, text]) => {
                bulbCtx.beginPath();
                bulbCtx.moveTo(lx + 70, ly);
                bulbCtx.lineTo(px, py);
                bulbCtx.stroke();
                const angle = Math.atan2(py - ly, px - (lx + 70));
                bulbCtx.beginPath();
                bulbCtx.moveTo(px, py);
                bulbCtx.lineTo(px - 8 * Math.cos(angle - Math.PI / 6), py - 8 * Math.sin(angle - Math.PI / 6));
                bulbCtx.moveTo(px, py);
                bulbCtx.lineTo(px - 8 * Math.cos(angle + Math.PI / 6), py - 8 * Math.sin(angle + Math.PI / 6));
                bulbCtx.stroke();
                bulbCtx.fillText(text, lx, ly);
            });
        }
        
        function v(id) { return parseFloat(document.getElementById(id).value); }
        
        // Sync slider and number input
        function syncInputs(sliderId, numId) {
            const slider = document.getElementById(sliderId);
            const num = document.getElementById(numId);
            
            slider.addEventListener('input', () => {
                num.value = slider.value;
                calc();
            });
            
            num.addEventListener('input', () => {
                let val = parseFloat(num.value);
                const min = parseFloat(slider.min);
                const max = parseFloat(slider.max);
                if (val < min) val = min;
                if (val > max) val = max;
                slider.value = val;
                calc();
            });
        }
        
        // Sync for view controls (pan/zoom) - only redraw, don't recalc
        function syncViewInputs(sliderId, numId) {
            const slider = document.getElementById(sliderId);
            const num = document.getElementById(numId);
            
            slider.addEventListener('input', () => {
                num.value = slider.value;
                draw();
            });
            
            num.addEventListener('input', () => {
                let val = parseFloat(num.value);
                const min = parseFloat(slider.min);
                const max = parseFloat(slider.max);
                if (val < min) val = min;
                if (val > max) val = max;
                slider.value = val;
                draw();
            });
        }
        
        function getTargetH(x, L) {
            const mode = document.querySelector('input[name="mode"]:checked').value;
            if (mode === 'flat') {
                return Math.min(v('bulb-h'), v('height'));
            } else {
                const amp = v('curve-amp'), freq = v('curve-freq');
                const offset = v('curve-offset'), base = v('curve-base');
                const xAdj = x - offset, xNorm = xAdj / L;
                return Math.max(0, base + amp * Math.sin(2 * Math.PI * freq * xNorm));
            }
        }
        
        function defl(L, d, H, w) {
            if (H <= 0) return Infinity; // Handle zero tension
            const dm = d/1000, A = Math.PI*(dm/2)**2;
            const wc = STEEL*A*G, wi = w.length ? w.reduce((a,b)=>a+b)*G/L : 0;
            return ((wc+wi)*L*L)/(8*H*1000);
        }
        
        function calc() {
            const L=v('span'), h=v('height'), d=v('diam'), H=v('tension'), n=parseInt(v('instances'));
            const gpm=v('gpm');
            const base = v('pcb')+v('housing')+v('conn')+v('eth')+v('socket')+v('bulb');
            let delta = 0;
            
            // Clear instance data
            instanceData = [];
            
            // Handle zero tension case
            if (H <= 0) {
                delta = h; // Cable sags to ground
            } else {
                for(let it=0; it<3; it++) {
                    cl=[]; cw=[];
                    for(let i=0; i<n; i++) {
                        const t=(i+1)/(n+1), x=L*t, dx=(x-L/2)/(L/2);
                        const y = h-delta*(1-dx*dx);
                        const targetH = getTargetH(x, L);
                        const len = Math.max(0, y-targetH);
                        cl.push(len);
                        cw.push(base + (gpm/1000)*len);
                    }
                    if(n>0) delta = defl(L,d,H,cw);
                }
            }
            
            // Build instance data for CSV export
            for(let i=0; i<n; i++) {
                const t=(i+1)/(n+1), x=L*t, dx=(x-L/2)/(L/2);
                const y = h-delta*(1-dx*dx);
                const targetH = getTargetH(x, L);
                const len = cl[i] || 0;
                const weight = cw[i] || 0;
                
                instanceData.push({
                    id: i,
                    x_position: x,
                    start_y: y,
                    end_y: targetH,
                    cable_length: len,
                    weight: weight
                });
            }
            
            cid = n>0 ? Math.min(cid, n-1) : 0;
            document.getElementById('id-input').value = cid;
            document.getElementById('id-input').max = Math.max(0, n-1);
            updCable();
            draw();
        }
        
        function updCable() {
            if(cid < cl.length) {
                const len=cl[cid], gpm=v('gpm'), w=(gpm/1000)*len;
                document.getElementById('cable-len').textContent = len.toFixed(3);
                document.getElementById('cable-w').value = w.toFixed(3);
            } else {
                document.getElementById('cable-len').textContent = '0.000';
                document.getElementById('cable-w').value = '0.000';
            }
            const tot = v('pcb')+v('housing')+v('conn')+v('eth')+v('socket')+v('bulb')+parseFloat(document.getElementById('cable-w').value||0);
            document.getElementById('total').textContent = tot.toFixed(3);
            
            const L=v('span'), d=v('diam'), dm=d/1000, A=Math.PI*(dm/2)**2;
            const cm = STEEL*A*L, iw = cw.reduce((a,b)=>a+b,0);
            const tl = cm+iw, tf = (tl*G)/1000;
            document.getElementById('f1').textContent = tl.toFixed(2);
            document.getElementById('f2').textContent = tf.toFixed(2);
            document.getElementById('f3').textContent = cm.toFixed(2);
            document.getElementById('f4').textContent = iw.toFixed(2);
        }
        
        function draw() {
            ctx.clearRect(0,0,920,460);
            const L=v('span'), h=v('height'), d=v('diam'), H=v('tension'), n=parseInt(v('instances'));
            const delta = (H <= 0) ? h : (cw.length ? defl(L,d,H,cw) : 0);
            const clVal = h-delta, th = h+delta;
            const LEFT=120, RIGHT=60, TOP=40, BOT=80;
            const bs = Math.min((920-LEFT-RIGHT)/L, (460-TOP-BOT)/th);
            const sc = bs*v('zoom'), px=v('pan-x')*L*sc, py=v('pan-y')*th*sc;
            const X = x => LEFT+x*sc+px;
            const Y = y => 460-BOT-y*sc+py;
            const lx=X(0), rx=X(L), gy=Y(0), ty=Y(h), ly=Y(clVal);
            const mode = document.querySelector('input[name="mode"]:checked').value;
            
            ctx.strokeStyle='#888'; ctx.lineWidth=2;
            ctx.beginPath(); ctx.moveTo(lx-60,gy); ctx.lineTo(rx+60,gy); ctx.stroke();
            
            ctx.fillStyle='black';
            ctx.fillRect(lx-3,ty,6,gy-ty); ctx.fillRect(rx-3,ty,6,gy-ty);
            
            ctx.strokeStyle='#aaa'; ctx.setLineDash([4,4]);
            ctx.beginPath(); ctx.moveTo(lx,ty); ctx.lineTo(rx,ty); ctx.stroke(); ctx.setLineDash([]);
            
            ctx.strokeStyle='blue'; ctx.lineWidth=2; ctx.beginPath();
            for(let i=0; i<=200; i++) {
                const t=i/200, x=L*t, dx=(x-L/2)/(L/2), y=h-delta*(1-dx*dx);
                if(i==0) ctx.moveTo(X(x),Y(y)); else ctx.lineTo(X(x),Y(y));
            }
            ctx.stroke();
            
            ctx.strokeStyle='green'; ctx.lineWidth=2;
            if(mode==='flat') ctx.setLineDash([6,4]);
            ctx.beginPath();
            for(let i=0; i<=200; i++) {
                const t=i/200, x=L*t, targetH = getTargetH(x, L);
                if(i==0) ctx.moveTo(X(x),Y(targetH)); else ctx.lineTo(X(x),Y(targetH));
            }
            ctx.stroke(); ctx.setLineDash([]);
            
            for(let i=0; i<n; i++) {
                const t=(i+1)/(n+1), x=L*t, dx=(x-L/2)/(L/2), y=h-delta*(1-dx*dx);
                const targetH = getTargetH(x, L);
                const cx=X(x), cy=Y(y), by=Y(targetH);
                ctx.strokeStyle = i==cid?'blue':'gray'; ctx.lineWidth = i==cid?2:1;
                ctx.beginPath(); ctx.moveTo(cx,cy); ctx.lineTo(cx,by); ctx.stroke();
                ctx.fillStyle='red'; ctx.beginPath(); ctx.arc(cx,cy,3,0,2*Math.PI); ctx.fill();
                
                // Draw rotated ID labels (90 degrees, reading upward)
                ctx.fillStyle = i==cid?'blue':'black'; 
                ctx.font = i==cid?'bold 10px Arial':'10px Arial';
                ctx.save();
                ctx.translate(cx, cy - 10);
                ctx.rotate(-Math.PI / 2); // Rotate 90 degrees counter-clockwise
                ctx.textAlign = 'left';
                ctx.textBaseline = 'middle';
                ctx.fillText(i.toString(), 0, 0);
                ctx.restore();
            }
            
            // Draw deflection text centered over the sag line, above the IDs
            const centerX = X(L/2);
            const centerY = Y(clVal); // Y position of lowest point of sag
            ctx.fillStyle='blue'; 
            ctx.font='bold 12px Arial';
            ctx.textAlign='center';
            ctx.fillText('Defl=' + delta.toFixed(2) + ' m', centerX, centerY - 35);
            
            ctx.strokeStyle='black'; ctx.fillStyle='black'; ctx.font='12px Arial'; ctx.lineWidth=1;
            ctx.beginPath(); ctx.moveTo(lx-35,ty); ctx.lineTo(lx-35,gy); ctx.stroke();
            ctx.textAlign='right'; ctx.fillText(h.toFixed(2)+' m',lx-41,(ty+gy)/2);
            
            const sy=gy+30;
            ctx.beginPath(); ctx.moveTo(lx,sy); ctx.lineTo(rx,sy); ctx.stroke();
            ctx.textAlign='center'; ctx.fillText(L.toFixed(2)+' m',(lx+rx)/2,sy+15);
            
            ctx.strokeStyle='black'; ctx.setLineDash([4,2]);
            ctx.beginPath(); ctx.moveTo(rx+30,gy); ctx.lineTo(rx+30,ly); ctx.stroke(); ctx.setLineDash([]);
            ctx.fillStyle='black'; ctx.textAlign='left'; ctx.fillText('Clear='+clVal.toFixed(2)+' m',rx+36,(gy+ly)/2);
        }
        
        function setId(newId) {
            const n = parseInt(v('instances'));
            if (n > 0) {
                cid = Math.max(0, Math.min(newId, n - 1));
                document.getElementById('id-input').value = cid;
                updCable();
                draw();
            }
        }
        
        function prevId() { 
            const n = parseInt(v('instances')); 
            if (n > 0) { 
                cid = (cid - 1 + n) % n; 
                document.getElementById('id-input').value = cid;
                updCable(); 
                draw(); 
            }
        }
        
        function nextId() { 
            const n = parseInt(v('instances')); 
            if (n > 0) { 
                cid = (cid + 1) % n; 
                document.getElementById('id-input').value = cid;
                updCable(); 
                draw(); 
            }
        }
        
        // ID input handler
        document.getElementById('id-input').addEventListener('input', function() {
            const n = parseInt(v('instances'));
            let val = parseInt(this.value) || 0;
            if (val < 0) val = 0;
            if (val >= n) val = n - 1;
            setId(val);
        });
        
        function save() {
            const mode = document.querySelector('input[name="mode"]:checked').value;
            const s = {
                span: v('span'),
                height: v('height'),
                diam: v('diam'),
                tension: v('tension'),
                instances: v('instances'),
                mode: mode,
                bulbH: v('bulb-h'),
                curveAmp: v('curve-amp'),
                curveOffset: v('curve-offset'),
                curveFreq: v('curve-freq'),
                curveBase: v('curve-base'),
                gpm: v('gpm'),
                bulbParts: {
                    pcb: v('pcb'),
                    housing: v('housing'),
                    conn: v('conn'),
                    eth: v('eth'),
                    socket: v('socket'),
                    bulb: v('bulb')
                }
            };
            const b = new Blob([JSON.stringify(s,null,2)],{type:'application/json'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(b); a.download = 'cable-sag.json'; a.click();
        }
        
        function load() {
            const inp = document.createElement('input'); inp.type='file'; inp.accept='.json';
            inp.onchange = e => {
                const r = new FileReader();
                r.onload = ev => {
                    try {
                        const s = JSON.parse(ev.target.result);
                        
                        // Handle both web format and Python format
                        document.getElementById('span').value = s.span;
                        document.getElementById('span-num').value = s.span;
                        document.getElementById('height').value = s.height;
                        document.getElementById('height-num').value = s.height;
                        document.getElementById('diam').value = s.diameter || s.diam;
                        document.getElementById('diam-num').value = s.diameter || s.diam;
                        document.getElementById('tension').value = s.tension;
                        document.getElementById('tension-num').value = s.tension;
                        document.getElementById('instances').value = s.instances;
                        document.getElementById('instances-num').value = s.instances;
                        
                        // Handle mode
                        let mode = 'flat';
                        if (s.bulb_cable_mode !== undefined) {
                            mode = s.bulb_cable_mode === 0 ? 'flat' : 'curve';
                        } else if (s.mode) {
                            mode = s.mode;
                        }
                        document.querySelector(`input[name="mode"][value="${mode}"]`).checked = true;
                        updateModeVisibility(mode);
                        
                        // Bulb height
                        const bulbH = s.bulbH || s.bulb_height || 2;
                        document.getElementById('bulb-h').value = bulbH;
                        document.getElementById('bulb-h-num').value = bulbH;
                        
                        // Curve parameters
                        const curveAmp = s.curveAmp || s.curve_amplitude || 3;
                        const curveOffset = s.curveOffset || s.curve_offset_x || 0;
                        const curveFreq = s.curveFreq || s.curve_frequency || 1;
                        const curveBase = s.curveBase || s.curve_base_height || 1;
                        
                        document.getElementById('curve-amp').value = curveAmp;
                        document.getElementById('curve-amp-num').value = curveAmp;
                        document.getElementById('curve-offset').value = curveOffset;
                        document.getElementById('curve-offset-num').value = curveOffset;
                        document.getElementById('curve-freq').value = curveFreq;
                        document.getElementById('curve-freq-num').value = curveFreq;
                        document.getElementById('curve-base').value = curveBase;
                        document.getElementById('curve-base-num').value = curveBase;
                        
                        // Grams per meter
                        document.getElementById('gpm').value = s.gpm || s.gramsPerMeter || s.grams_per_meter || 50;
                        
                        // Bulb parts
                        const parts = s.bulbParts || s.bulb_parts || {};
                        document.getElementById('pcb').value = parts.pcb || parts.PCB || 0.05;
                        document.getElementById('housing').value = parts.housing || parts.Housing || 0.12;
                        document.getElementById('conn').value = parts.conn || parts.connectors || parts.Connectors || 0.035;
                        document.getElementById('eth').value = parts.eth || parts.ethernet || parts.Ethernet || 0.025;
                        document.getElementById('socket').value = parts.socket || parts.Socket || 0.045;
                        document.getElementById('bulb').value = parts.bulb || parts.Bulb || 0.065;
                        
                        calc();
                        alert('Settings loaded successfully!');
                    } catch(err) { 
                        alert('Load error: ' + err.message); 
                        console.error('Load error:', err);
                    }
                };
                r.readAsText(e.target.files[0]);
            };
            inp.click();
        }
        
        function exportCSV() {
            if (instanceData.length === 0) {
                alert('No instance data to export. Please ensure you have at least 1 instance.');
                return;
            }
            
            // Build CSV content
            const headers = ['ID', 'X_Position_m', 'Start_Y_m', 'End_Y_m', 'Cable_Length_m', 'Weight_kg'];
            let csvContent = headers.join(',') + '\n';
            
            instanceData.forEach(inst => {
                const row = [
                    inst.id,
                    inst.x_position.toFixed(4),
                    inst.start_y.toFixed(4),
                    inst.end_y.toFixed(4),
                    inst.cable_length.toFixed(4),
                    inst.weight.toFixed(4)
                ];
                csvContent += row.join(',') + '\n';
            });
            
            // Create and download file
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'cable-sag-instances.csv';
            a.click();
        }
        
        function updateModeVisibility(mode) {
            const isCurve = mode === 'curve';
            document.getElementById('flat-ctrl').style.display = isCurve ? 'none' : 'block';
            document.getElementById('curve-ctrl').style.display = isCurve ? 'block' : 'none';
        }
        
        // Setup slider/number sync for main controls
        syncInputs('span', 'span-num');
        syncInputs('height', 'height-num');
        syncInputs('diam', 'diam-num');
        syncInputs('tension', 'tension-num');
        syncInputs('instances', 'instances-num');
        syncInputs('bulb-h', 'bulb-h-num');
        syncInputs('curve-amp', 'curve-amp-num');
        syncInputs('curve-offset', 'curve-offset-num');
        syncInputs('curve-freq', 'curve-freq-num');
        syncInputs('curve-base', 'curve-base-num');
        
        // Setup slider/number sync for view controls
        syncViewInputs('pan-x', 'pan-x-num');
        syncViewInputs('pan-y', 'pan-y-num');
        syncViewInputs('zoom', 'zoom-num');
        
        // Mode radio buttons
        document.querySelectorAll('input[name="mode"]').forEach(radio => {
            radio.addEventListener('change', () => {
                const mode = document.querySelector('input[name="mode"]:checked').value;
                updateModeVisibility(mode);
                calc();
            });
        });
        
        // Bulb part inputs
        ['pcb','housing','conn','eth','socket','bulb','gpm'].forEach(id => {
            document.getElementById(id).addEventListener('input', calc);
        });
        
        console.log('Running initial calc...');
        drawBulbDiagram();
        calc();
        console.log('Done!');
    </script>
</body>
</html>
